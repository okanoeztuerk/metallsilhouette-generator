<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wandbild-Konfigurator</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fdfdfd;
      padding: 20px;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 0.25rem;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      margin-top: 0.25rem;
      box-sizing: border-box;
    }
    button {
      background: #2c7a7b;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2>Wandbild konfigurieren</h2>
  <form id="konfigurator-form" enctype="multipart/form-data">
    <div class="form-group">
      <label for="image">Bild hochladen</label>
      <input type="file" name="image" id="image" accept="image/*" required>
    </div>
    <div class="form-group">
      <label for="color">Farbe</label>
      <input type="color" name="color" id="color" value="#8b7628">
    </div>
    <div class="form-group">
      <label for="shape">Form</label>
      <select name="shape" id="shape">
        <option value="circle">Kreis</option>
        <option value="square">Quadrat</option>
        <option value="realHeart">Herz</option>
        <option value="S">S</option>
        <option value="I">I</option>
      </select>
    </div>
    <div class="form-group">
      <label for="width_cm">Breite (cm)</label>
      <input type="number" name="width_cm" id="width_cm" value="100" min="30" max="200" required>
    </div>
    <button type="submit" id="generate-btn">Vorschau generieren</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('konfigurator-form');
      const btn  = document.getElementById('generate-btn');

      if (!form) {
        console.error('‚ùå Formular #konfigurator-form nicht gefunden!');
        return;
      }
      console.log('‚úÖ Formular geladen, warte auf Submit‚Ä¶');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btn.disabled = true;
        btn.textContent = 'Lade‚Ä¶';
        console.log('‚è≥ Sende Formular an /api/generate-shopify');

        try {
            const resp = await fetch('/api/generate-shopify', {
           method: 'POST',
           body: new FormData(form)
         });
         const data = await resp.json();
         if (!resp.ok) {
           console.error('üö® Server-Error:', data);
           alert('Fehler beim Generieren:\n' + (data.error || resp.statusText));
           return;
         }
         console.log('‚úÖ Antwort erhalten:', data);

          // Nachricht ans Parent-Window
          window.parent.postMessage({
            type:              'wandbild_ready',
            output_preview_url: data.output_preview_url,
            output_png_url:     data.output_png_url,
            output_svg_url:     data.output_svg_url,
            image_uid:          data.image_uid
          }, '*');

          btn.textContent = 'Vorschau generiert';
        } catch (err) {
          console.error('‚ùå Fehler beim Generieren:', err);
          alert('Fehler beim Generieren ‚Äì siehe Konsole.');
          btn.textContent = 'Vorschau generieren';
        } finally {
          btn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
